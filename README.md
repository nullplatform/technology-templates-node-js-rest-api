<h2 align="center">
    <a href="https://httpie.io" target="blank_">
        <img height="100" alt="nullplatform" src="https://nullplatform.com/favicon/android-chrome-192x192.png" />
    </a>
    <br>
    <br>
    Technology Templates Node.js Rest API
    <br>
</h2>

Welcome to the **Technology Templates Node.js Rest API** repository!

## Table of Contents

- [Introduction](#introduction)
- [Getting Started](#getting-started)
- [Development](#development)
- [Testing](#testing)
- [Production](#production)
- [Environments](#environments)
- [OpenAPI Specification](#openapi-specification)

## Introduction

This API handles all _<<feature_a>>_ and its _related <<features_b>>_

## Getting Started

To get started, follow these steps:

1. **Install Required Dependencies**:

   This project requires [Docker](https://www.docker.com/get-started/) installed and running
   since uses local [PostgresSQL](https://www.postgresql.org/) databases and [Wiremock](https://wiremock.org/)

2. **Install Project Dependencies**:

   ```bash
   npm install
   ```

## Development

You can launch this application locally by executing:

1. launch local dependencies & mocks

   ```bash
   npm run compose:up
   ```

2. create required databases and schemas

   ```bash
   npm run migrate
   ```

3. finally start application

   ```bash
   npm run start
   ```

## Testing

All existing tests are located in the _test_ folder. You can execute them by running:

```bash
npm run test
```

## Production

The first time you bring this application to production you must pre-create some database users:

1. A migration DB user

   ```sql
   CREATE USER <<your_api_name_here>>_migration WITH ENCRYPTED PASSWORD '<your_password_here>';
   GRANT CREATE ON DATABASE <<your_database_name_here>> TO <<your_api_name_here>>_migration;
   ```

   Create a _migration_ scope and modify parameter named _DATABASE_PASSWORD_ for that scope with the password you specified previously for _feature_flag_management_migration_ user

2. Run migrations

- Get a valid token with permissions to run migrations using this [<<your_api_name_here>>\_MIGRATION_API_KEY](https://dashboard.doppler.com/workplace/5ba3e33db84a68f0788b/projects/customers/configs/prd_nullplatform)

- Run this command replacing _\<\<\<token\>\>\>_ with the actual token generated by using the specified API key
  ```shell
  curl --request GET \
  --url 'https://<<your_migration_scope_domain_here>>.prod.nullapps.io/?option=migrate' \
  --header 'Authorization: Bearer <<<token>>>'
  ```
- You can replace _option_ with these values:
  - **migrate**: to run pending database migrations
  - **undo**: to undo last migration
  - **undo:all** to undo **all** migrations. Be careful, this will delete the **entire** database schema.

3. An application DB user

   ```sql
   CREATE USER <<your_api_name_here>>_runtime WITH ENCRYPTED PASSWORD '<your_password_here>';
   ```

   Create a _production_ scope and then create a parameter for this scope named _DATABASE_PASSWORD_ with the password you specified previously for _<<your_api_name_here>>\_runtime_ user

4. Add permissions to _<<your_api_name_here>>\_runtime_ user

   ```sql
   GRANT USAGE ON SCHEMA production TO <<your_api_name_here>>_runtime;
   GRANT SELECT, INSERT, UPDATE ON ALL TABLES IN SCHEMA production TO <<your_api_name_here>>_runtime;
   GRANT SELECT, UPDATE ON ALL SEQUENCES IN SCHEMA production TO <<your_api_name_here>>_runtime;
   ```

## Environments

This project is designed to operate independently, leveraging Docker containers for key dependencies like a local PostgresSQL database and Wiremock for external service simulation.

Explore the _config_ folder to access predefined values for different environments. Customize your environment by setting the _NODE_ENV_ variable to one of the following options: _development_, _production_, or _test_.

For more granular control, modify the configuration values by adjusting the corresponding environment variables. A detailed list of these variables is available [here](https://github.com/nullplatform/<<your_api_respository_name_here>>/blob/main/config/custom-environment-variables.json).
Ensure that you fine-tune these settings according to your specific needs and preferences.

## OpenAPI Specification

This API automatically generates an OpenAPI V3 specification based on validation and serialization schemas.

To generate an OpenAPI specification enable swagger flag in [development](https://github.com/nullplatform/<<your_api_respository_name_here>>/blob/main/config/development.json5) config:

```json
{
  server: {
    openAPI: {
      enabled: false, // Disable OpenAPI for development
      ...
    }
  },
}
```

then start the application:

```bash
npm run start
```

and download the specification under the _/documentation/yaml_ URL, by default should be [this one](http://localhost:8080/documentation/yml)
